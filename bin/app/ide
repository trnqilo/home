#!/usr/bin/env bash
set -e

if [[ "$1" == 'jbt' ]]; then
  if whereami darwin; then open -a 'JetBrains Toolbox'
  else
    whereami windows && cd "$LOCALAPPDATA" || cd "$HOME/.local/share"
    secretly ./JetBrains/Toolbox/bin/jetbrains-toolbox
  fi
  exit
fi

declare -A ides=(
  ['as']='studio'
  ['ij']='idea'
  ['jr']='rider'
  ['rr']='rustrover'
  ['vs']='start devenv'
  ['xc']='xcopen'
)

function set_ide { ide="${ides["$1"]}"; }

if [[ "$1" ]]; then set_ide "$1"; fi

if [[ "$ide" ]]; then shift
elif [[ -d "$1" ]]; then
    if quietly "cd '$1'; ls ./*/*/main/AndroidManifest.xml"; then set_ide as
  elif quietly "cd '$1'; ls ./*.uproject"; then set_ide jr
  elif quietly "cd '$1'; ls ./Cargo.toml"; then set_ide rr
  elif quietly "cd '$1'; ls ./Package.swift"; then set_ide xc
  elif quietly "cd '$1'; ls ./*.xcodeproj"; then set_ide xc
  elif quietly "cd '$1'; ls ./*.xcworkspace"; then set_ide xc
  elif quietly "cd '$1'; ls ./package.json"; then set_ide ij
  elif quietly "cd '$1'; ls ./pubspec.yaml"; then set_ide ij
  elif quietly "cd '$1'; ls ./*.sln"; then set_ide vs; fi
fi

ide="${ide:-idea}"
if ! cd "$1" &>/dev/null; then echo "not a project: $1"; exit; fi
current_dir="`pwd`"
if [[ "$current_dir" == "$HOME" ]]; then surely 'open home'
elif [[ "$current_dir" != "$HOME/"* && "$current_dir" != "$PROJECTS/"* ]]; then surely "open $current_dir"
else surely sure "$ide $current_dir"; fi

if type "$ide" &>/dev/null; then
  $ide . > /dev/null 2>&1 &
else
  echo "not found: $ide"
fi
