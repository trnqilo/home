#!/usr/bin/env bash
set -e

[[ -f "$HOLO/bin/homeup" ]] && exit || cd

mv .git.home .git &>/dev/null ||:
mv .home/readme . &>/dev/null ||:
mv .home/license . &>/dev/null ||:

if git fetch &>/dev/null; then
  branch="`git rev-parse --abbrev-ref HEAD`"
  git diff origin/$branch --name-status | parrot magenta
  git reset --hard origin/$branch ||:
fi

mv .git .git.home
mv readme .home/ &>/dev/null ||:
mv license .home/ &>/dev/null ||:

if cd "$HOLO/.git/.." &>/dev/null && ! test -z "`git remote -v`"; then
    git count-objects; git fetch
else exit; fi

if [[ "$HOLORO" ]]; then git reset --hard origin/main
else
  git diff origin/main --name-status | parrot magenta; git pull origin main
  if ! git status | grep "nothing to commit"; then
    git add -A
    if [[ "$HOLOSQUASH" == true || "$1" == 'squash' ]]; then
      [[ ! "$HOLOSQUASH" ]] && surely sure squash || exit
      git commit --amend -C HEAD
      forces='--force-with-lease --force-if-includes'
      head=$(git rev-parse HEAD)
      tail=$(git rev-list --max-parents=0 HEAD)
      if [ "$head" != "$tail" ]; then
        git reset --soft "$tail" && git add -A && git commit --amend --no-edit
      fi
    else
      git commit -m"`date`"
    fi
  fi
fi
git push origin main $forces -u
git gc && git count-objects
