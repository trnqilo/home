#!/usr/bin/env bash
set -e

function _fszfs_pool { sudo zpool create $@; }

function _fszfs_import {  # pool zfs
  sudo zpool import $1 -f
  sudo zfs import $2 -f
}

function _fszfs_create {
  if [[ "$encrypt" != false ]]; then zfs_opts='-o encryption=on -o keyformat=passphrase'; fi
  sudo zfs create $zfs_opts -o compression=on "$1/$2"
  if [[ "$3" ]]; then _fszfs_mountpoint $@; fi
}

function _fszfs_mountpoint { sudo zfs set mountpoint="$3" "$1/$2"; }

function _fszfs_mount {
  sudo zfs load-key "$1/$2" ||:
  sudo zfs mount "$1/$2"
}

function _fszfs_unmount {
  sudo zfs umount "$1/$2" ||:
  sudo zfs unload-key "$1/$2"
}

function _fszfs_list {
  sudo zpool list -v
  sudo zfs list
}

function _fszfs_destroy {
  [[ "$3" ]] && snapshot+="@$3" || snapshot=
  surely && sudo zfs destroy -r "${1}/${2}${snapshot}"
}

function _fszfs_snapshot { sudo zfs list -t snapshot; }

function _fszfs_samba { share smb $@; }

function _fszfs_nfs { share nfs $@; }

function _fszfs_gc { sudo zsysctl service gc --all; }

function _fszfs_packages { sudo apt install zpool zfs zfs-dkms zfsutils-linux; }

# wip: eg. fszfs iddqd zpool123 zfs/username google-chrome
function _fszfs_iddqd { local pool="$1" user="$2" bin="$3"
  _fszfs_mount "$pool" "$user" ||:
  iddqd "$user" x $bin ||:
  _fszfs_unmount "$pool" "$user" ||:
}

function share { share=$1; shift
  if [[ "$2" ]]; then sudo zfs set "share${share}=${3:-on}" "$1/$2"; fi
  sudo zfs get "share${share}"
}

_fszfs_${@:-list}
